[meta]
id = "dual-levers"
room_number = 2
title = "The Dual Levers"
concept = "one_writer_only"

[narrative]
entry = """
Through the hidden door, a narrow passage leads deeper.

Torchlight flickers ahead. You hear grinding stoneâ€”
some ancient mechanism awaits.
"""

intro = """
Two levers control the gate mechanism. A sign reads:
"PULL EACH LEVER IN SEQUENCE TO OPEN"

You and your ally each grab a lever at the same time,
ready to pull. But the mechanism jams!

The ancient machinery can't handle two hands pulling
at once. One must release before the other can act.
"""

success = """
You pull your lever, release it. Your ally pulls theirs.
CLUNK. CLUNK. The gate rises!

> WORDS OF WISDOM: Only ONE mutable borrow (&mut) can
> exist at a time. Two writers would corrupt the data.
>
> Think of it like a lock - one key holder at a time.
> Finish your mutation, then pass control.

The gate rumbles open. Something moves in the darkness ahead...
"""

failure_compile = "The mechanism jams! Two hands grip the levers at once..."
failure_output = "The gate remains sealed."

hints = [
    "Two &mut references exist at the same time. The mechanism can't handle that.",
    "You need to USE the first lever, then create the second reference.",
    "Remove the early &mut declarations. Just use mechanism.push_str() directly, twice."
]

alternative_solution = "The simplest fix: don't create named &mut variables at all. Just call the method directly on the data twice in sequence."

[puzzle]
code = '''
fn main() {
    let mut mechanism = String::from("[gate:");

    let lever1 = &mut mechanism;
    let lever2 = &mut mechanism;

    lever1.push_str(" LEFT");
    lever2.push_str(" RIGHT]");

    println!("{mechanism}");
}
'''

expected_output = "[gate: LEFT RIGHT]"

locked_lines = [2, 9]

[scoring]
par_time_seconds = 180
hint_penalty_hp = 5
wrong_answer_penalty_hp = 2

[codex]
title = "One Writer Rule"
description = """
Only ONE &mut reference can exist at a time.
Two writers would corrupt the data.

  let mut data = String::new();

  // BAD: two &mut at once
  let a = &mut data;
  let b = &mut data;  // ERROR!

  // GOOD: one at a time
  data.push_str("first");
  data.push_str("second");

Finish mutating, then pass control.
"""
