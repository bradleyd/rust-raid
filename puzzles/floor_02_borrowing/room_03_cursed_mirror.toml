[meta]
id = "cursed-mirror"
room_number = 3
title = "The Cursed Mirror"
concept = "no_mixed_borrows"

[narrative]
intro = """
A cursed mirror hangs on the wall. To break the curse, you must
read the inscription AND modify it at the same time.

But the mirror's magic is ancient and strict: while anyone is
reading, no one may write. While anyone writes, no one may read.

The current spell tries to hold a reader and a writer simultaneously...
"""

success = """
You release the reading lens, then take up the chisel. The inscription
changes. The curse lifts, and your reflection returns to normal.

> WORDS OF WISDOM: You cannot have &mut while any & exists.
> Readers assume data won't change under them. A writer would
> violate that trust. "Readers OR a writer, never both."
> This is Rust's key insight for memory safety.

The mirror clears. Level 2 complete!
"""

failure_compile = "The mirror cracks. Reading and writing cannot coexist..."
failure_output = "The curse remains. The inscription is unchanged."

hints = [
    "You have an immutable borrow (&) and then try to get a mutable one (&mut).",
    "The reader 'reflection' is still alive when you try to modify the mirror.",
    "Use the reflection BEFORE taking the mutable borrow, or drop it first."
]

alternative_solution = "The fix is about ordering: finish all reads before you write. Rust's borrow checker ensures readers never see data changing mid-read."

[puzzle]
code = '''
fn main() {
    let mut mirror = String::from("CURSED");

    let reflection = &mirror;
    let chisel = &mut mirror;

    println!("Reading: {reflection}");
    chisel.push_str(" NO MORE");
    println!("After: {mirror}");
}
'''

expected_output = """Reading: CURSED
After: CURSED NO MORE"""

locked_lines = [2, 10]

[scoring]
par_time_seconds = 180
hint_penalty_hp = 5
wrong_answer_penalty_hp = 2
